<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Roadmap Visualiser</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

      :root {
        --bg: #f8f9fb;
        --card: #ffffff;
        --text: #0f0f13;
        --muted: #5a5a67;
        --border: #e7e9f0;
        --accent1: #6C63FF;  /* purple */
        --shadow: 0 4px 16px rgba(0,0,0,0.04);

        --warn-bg: #fff6e5;
        --warn-text: #8a5b00;
        --warn-border: #ffd89e;

        /* chips */
        --chip-bg: #f3f4f9;
        --chip-text: #2c2c35;
        --chip-border: #e3e6ef;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b0c10;
          --card: #14151b;
          --text: #f3f4f8;
          --muted: #a3a3b5;
          --border: #24262e;
          --accent1: #8b82ff;
          --shadow: 0 4px 20px rgba(0,0,0,0.5);

          --warn-bg: #2b210e;
          --warn-text: #ffd79a;
          --warn-border: #3a2b11;

          --chip-bg: #1b1e2c;
          --chip-text: #e7e9f5;
          --chip-border: #2a2f45;
        }
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }

      body {
        font-family: 'Inter', system-ui, sans-serif;
        color: var(--text);
        background: var(--bg);
        margin: 0;
        padding: 40px clamp(16px, 5vw, 64px);
      }

      /* --- top bar --- */
      .topbar{
        display:flex; align-items:center; justify-content:space-between;
        margin-bottom: 18px; padding: 10px 14px;
        background: var(--card); border:1px solid var(--border); border-radius:14px;
        box-shadow: var(--shadow);
      }
      .brand{ display:flex; gap:10px; align-items:center; font-weight:700; }
      .brand span{ font-size: 16px; letter-spacing: .1px; }
      .topbar .brand { margin-right: auto; }

      .btn-ghost{
        background: transparent; color: var(--text);
        border:1px solid var(--border);
        padding:8px 10px; border-radius:10px;
        box-shadow:none; cursor:pointer;
      }
      .btn-ghost:hover{ box-shadow: 0 3px 10px rgba(0,0,0,.06); }

      .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0; }

      /* Headings: solid colour (no gradient) */
      h1 {
        display:flex; align-items:center; gap:8px;
        font-weight: 700;
        font-size: clamp(28px, 3vw, 38px);
        color: var(--accent1);
        margin: 0 0 12px;
      }
      h2 { color: var(--accent1); font-weight: 600; margin: 32px 0 12px; }

      /* Count pill: grey */
      #count {
        font-size: 12px;
        padding: 2px 8px;
        border-radius: 999px;
        background: #eef0f5;
        color: #2b2e3a;
        border: 1px solid #d9dce6;
        margin-left: 8px;
      }

      .controls {
        margin: 20px 0 28px;
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }
      label {
        font-size: 13px;
        color: var(--muted);
        display:inline-flex; gap:8px; align-items:center;
        background: var(--card);
        padding: 8px 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        box-shadow: var(--shadow);
        position: relative; overflow: hidden;
      }
      input, select, textarea {
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 8px 10px;
        font-family: inherit;
        background: var(--card);
        color: var(--text);
        outline: none;
        transition: border 0.2s ease, box-shadow 0.2s ease;
        min-width: 0;
      }
      input:focus, select:focus, textarea:focus {
        box-shadow: none;
        outline: 2px solid var(--accent1);
        outline-offset: -2px;
      }
      label:focus-within { border-color: var(--accent1); }

      .toolbar{ display:flex; gap:10px; margin-left:auto; flex-wrap:wrap; }

      /* Primary buttons: solid purple (no gradient) */
      .btn {
        border: none;
        background: #6C63FF;
        color: white;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px 16px;
        cursor: pointer;
        box-shadow: 0 3px 12px rgba(108, 99, 255, .25);
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity .15s ease;
      }
      .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(108, 99, 255, .35); }
      .btn:active { transform: translateY(0); }
      .btn[disabled]{ opacity:.6; cursor:not-allowed; }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
      }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        box-shadow: var(--shadow);
        padding: 18px 20px;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }
      .card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }

      /* Quarter pills: simple grey */
      .pill {
        display: inline-block;
        background: #eef0f5 !important;
        color: #2b2e3a !important;
        border: 1px solid #d9dce6 !important;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        margin-left: 8px;
      }
      @media (prefers-color-scheme: dark){
        .pill{
          background:#1d2030 !important;
          color:#e7e9f5 !important;
          border-color:#2a2f45 !important;
        }
      }

      .meta { font-size: 13px; color: var(--muted); margin-top: 6px; word-break: break-word; }
      .score { font-weight: 700; color: var(--accent1); }

      .warn {
        margin-top:8px;
        background: var(--warn-bg);
        color: var(--warn-text);
        border: 1px solid var(--warn-border);
        padding: 6px 10px;
        border-radius:10px;
        font-size:12px;
      }

      /* Add project form */
      .form {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 20px;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        box-shadow: var(--shadow);
      }
      .form label{ display: grid; gap: 6px; align-content: start; }
      .form textarea{ min-height: 80px; resize: vertical; }
      .help { font-size: 13px; color: var(--muted); margin: 8px 0 16px; }

      /* Dependency chips */
      .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:6px; }
      .chip{
        display:inline-flex; align-items:center; gap:6px;
        background: var(--chip-bg);
        color: var(--chip-text);
        border: 1px solid var(--chip-border);
        border-radius: 999px;
        padding: 4px 10px;
        font-size:12px;
        cursor:pointer;
      }
      .chip:hover{ filter: brightness(.98); }

      /* Planner panel */
      .planner{
        background: var(--card);
        border:1px solid var(--border);
        border-radius:18px;
        padding:16px;
        box-shadow: var(--shadow);
      }
      .plan-results{ margin-top:12px; font-size:14px; }
      .plan-results ul{ margin:8px 0 0 18px; }
    </style>

    <!-- Optional dev config: remove in production
    <script>
      window.AI_API_KEY = "YOUR_KEY";
      window.AI_ENDPOINT = "https://your-llm-endpoint.example/rice";
    </script>
    -->
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <svg width="22" height="22" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor" d="M12 2l1.9 4.8L19 8l-4.7 2 1.7 5.1L12 12.8 8 15.1 9.7 10 5 8l5.1-1.2L12 2z"/>
        </svg>
        <span>Roadmap Visualiser</span>
      </div>
      <button id="themeToggle" class="btn-ghost" type="button" title="Toggle dark / light">
        <span id="themeIcon" aria-hidden="true">🌙</span>
        <span id="themeLabel" class="sr-only">Dark</span>
      </button>
    </header>

    <h1>Roadmap Visualiser <span id="count"></span></h1>

    <div class="controls">
      <label>Quarter:
        <select id="quarterFilter">
          <option value="">All</option>
          <option>2025 Q1</option>
          <option>2025 Q2</option>
          <option>2025 Q3</option>
          <option>2025 Q4</option>
        </select>
      </label>
      <label>Sort by:
        <select id="sortBy">
          <option value="rice">RICE (desc)</option>
          <option value="impact">Impact (desc)</option>
          <option value="effort">Effort (asc)</option>
        </select>
      </label>
      <label>Search:
        <input id="search" placeholder="Search titles…"/>
      </label>
      <div class="toolbar">
        <button id="downloadBtn" class="btn">Download JSON</button>
        <button id="resetLocalBtn" class="btn" title="Clear only your browser’s saved items">Reset local</button>
        <button id="themesBtn" class="btn-ghost" type="button" title="Group items by theme">Themes</button>
        <button id="weeklyBtn" class="btn-ghost" type="button" title="Exec summary of changes since last week">Weekly summary</button>
      </div>
    </div>

    <div class="grid" id="grid"></div>

    <!-- Capacity planner -->
    <div class="section">
      <h2>Capacity fit</h2>
      <div class="planner">
        <div class="help">
          Enter team capacity in <strong>Effort units</strong> for the selected quarter, then click
          <strong>Suggest plan</strong>. We’ll choose the mix of projects that
          <strong>maximises total RICE</strong> without exceeding capacity. We also try to include any
          <strong>dependencies</strong>.
        </div>
        <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
          <label>Quarter
            <select id="planQuarter">
              <option>2025 Q1</option><option>2025 Q2</option><option>2025 Q3</option><option>2025 Q4</option>
            </select>
          </label>
          <label>Capacity
            <input id="planCapacity" type="number" min="1" value="8" />
          </label>
          <button id="planBtn" class="btn">Suggest plan</button>
        </div>
        <div id="planOut" class="plan-results"></div>
      </div>
    </div>

    <div class="section">
      <h2>Add a project</h2>
      <div class="help">This updates your view immediately and saves to your browser only (localStorage). Use “Download JSON” to export and commit later.</div>

      <div class="form" id="addForm">
        <label>Title<br/><input id="f_title" required /></label>
        <label>Quarter<br/>
          <select id="f_quarter">
            <option>2025 Q1</option><option>2025 Q2</option>
            <option>2025 Q3</option><option>2025 Q4</option>
          </select>
        </label>
        <label>Owner<br/><input id="f_owner" placeholder="e.g., Sarah" /></label>
        <label>Team<br/><input id="f_team" placeholder="e.g., Core" /></label>
        <label>Reach<br/><input id="f_reach" type="number" min="0" value="100" /></label>
        <label>Impact<br/>
          <select id="f_impact">
            <option value="3">3 — Huge</option>
            <option value="2" selected>2 — Medium</option>
            <option value="1">1 — Small</option>
            <option value="0.5">0.5 — Very minor</option>
            <option value="0.25">0.25 — Minimal</option>
          </select>
        </label>
        <label>Confidence<br/>
          <select id="f_confidence">
            <option value="1">1.0 — Strong data</option>
            <option value="0.8" selected>0.8 — Fairly confident</option>
            <option value="0.6">0.6 — Moderate</option>
            <option value="0.4">0.4 — Low</option>
          </select>
        </label>
        <label>Effort<br/>
          <select id="f_effort">
            <option value="1">1 — ~1 week</option>
            <option value="2" selected>2 — ~2–3 weeks</option>
            <option value="3">3 — ~1 month</option>
            <option value="4">4 — 1–2 months</option>
            <option value="5">5 — 2+ months</option>
          </select>
        </label>

        <label style="grid-column:1/-1;">Dependencies<br/>
          <input id="f_depends" placeholder="Type exact project titles, comma-separated" />
          <div class="help" style="margin:4px 0 0">
            List any projects this one <em>needs first</em>. Use exact titles. Example: <code>SDK adapter layer, Data pipeline</code>
          </div>
          <div id="dep_suggest" class="chips" aria-live="polite"></div>
        </label>

        <label style="grid-column:1/-1;">Description<br/>
          <textarea id="f_description" placeholder="One-liner scope / why it matters"></textarea>
        </label>

        <div class="row" style="grid-column:1/-1; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
          <button class="btn" id="addBtn">Add</button>
          <button class="btn-ghost" id="aiLocalBtn" type="button" title="Heuristic score from title/description (no API)">Quick score</button>
          <button class="btn-ghost" id="askAIBtn" type="button" title="Use your LLM endpoint to suggest ranges">Ask AI</button>
          <span id="aiNote" class="help" style="margin:0;">Ask AI is hidden without an <code>AI_API_KEY</code>.</span>
        </div>

        <div id="aiExplain" class="help" style="grid-column:1/-1; display:none;"></div>
      </div>

      <div id="themesSection" class="section" style="display:none;">
        <h2>Themes (auto)</h2>
        <div id="themesOut" class="grid"></div>
      </div>

      <div id="weeklySection" class="section" style="display:none;">
        <h2>Weekly exec summary</h2>
        <div id="weeklyOut" class="card"></div>
      </div>
    </div>

    <!-- Dev only: set your key/endpoint to enable Ask AI
    <script>
      window.AI_API_KEY = "your-dev-key";
      window.AI_ENDPOINT = "https://your-endpoint.example/rice";
    </script>
    -->

    <script>
      const AI_KEY = window.AI_API_KEY || null;
      const AI_ENDPOINT = window.AI_ENDPOINT || null;

      const state = { items: [], quarter: "", sortBy: "rice", search: "" };
      const LS_KEY = "roadmap_custom_items_v1";
      const THEME_KEY = "rv_theme";
      const SNAP_KEY = "rv_snapshot_v1";

      function riceScore(i){ return Math.round((i.reach * i.impact * i.confidence) / Math.max(1, i.effort)); }
      function escapeHtml(s){ return String(s || "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      function val(id){ return document.getElementById(id).value; }
      function num(id){ return parseFloat(val(id) || '0'); }

      async function load() {
        const res = await fetch('data.json', {cache:'no-store'});
        const base = await res.json();
        const extra = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        state.items = [...base, ...extra];
        render();
        refreshDepSuggestions();
      }

      function render(){
        const q = state.quarter, s = state.sortBy, term = state.search.toLowerCase();
        let filtered = state.items.filter(i => (!q || i.quarter === q) && i.title.toLowerCase().includes(term));

        filtered.sort((a,b)=>{
          if(s==="impact") return (b.impact - a.impact);
          if(s==="effort") return (a.effort - b.effort);
          return (riceScore(b) - riceScore(a));
        });

        document.getElementById('count').textContent = filtered.length + " items";

        const byTitle = new Map(state.items.map(i => [i.title.trim().toLowerCase(), i]));
        document.getElementById('grid').innerHTML = filtered.map(i=>{
          const deps = (i.dependsOn || []).filter(Boolean);
          const missing = deps.filter(d => !byTitle.has(d.trim().toLowerCase()));
          const depsHtml = deps.length ? `<div class="meta">Dependencies: ${deps.map(escapeHtml).join(', ')}</div>` : '';
          const warnHtml = missing.length ? `<div class="warn">Missing dependency: ${missing.map(escapeHtml).join(', ')}</div>` : '';

          return `
          <div class="card">
            <div><strong>${escapeHtml(i.title)}</strong> <span class="pill">${escapeHtml(i.quarter || '')}</span></div>
            <div class="meta">Owner: ${escapeHtml(i.owner || '—')} | Team: ${escapeHtml(i.team || '—')}</div>
            <div class="meta">Reach ${i.reach}, Impact ${i.impact}, Confidence ${i.confidence}, Effort ${i.effort}</div>
            <div class="meta score">RICE: ${riceScore(i)}</div>
            ${depsHtml}
            ${warnHtml}
            <p>${escapeHtml(i.description || '')}</p>
          </div>`;
        }).join('');
      }

      // Dependency suggestions
      const depInput = document.getElementById('f_depends');
      const depSuggest = document.getElementById('dep_suggest');

      function tokeniseDeps(){ return depInput.value.split(',').map(s => s.trim()).filter(Boolean); }
      function currentDepQuery(){
        const raw = depInput.value;
        const lastComma = raw.lastIndexOf(',');
        const q = lastComma === -1 ? raw : raw.slice(lastComma+1);
        return q.trim().toLowerCase();
      }
      function refreshDepSuggestions(){
        const query = currentDepQuery();
        const chosen = new Set(tokeniseDeps().map(s => s.toLowerCase()));
        const options = state.items
          .map(i => i.title)
          .filter(t => t && !chosen.has(t.toLowerCase()))
          .filter(t => !query || t.toLowerCase().includes(query))
          .slice(0, 12);
        depSuggest.innerHTML = options.map(t => `<button type="button" class="chip" data-title="${escapeHtml(t)}">${escapeHtml(t)}</button>`).join('');
      }
      depInput.addEventListener('input', refreshDepSuggestions);
      depSuggest.addEventListener('click', (e) => {
        const btn = e.target.closest('.chip');
        if(!btn) return;
        const title = btn.getAttribute('data-title');
        let parts = depInput.value.split(',').map(s=>s.trim()).filter(Boolean);
        if(!parts.includes(title)) parts.push(title);
        depInput.value = parts.join(', ');
        refreshDepSuggestions();
      });

      // Filters
      document.getElementById('quarterFilter').addEventListener('change', e => { state.quarter = e.target.value; render(); });
      document.getElementById('sortBy').addEventListener('change', e => { state.sortBy = e.target.value; render(); });
      document.getElementById('search').addEventListener('input', e => { state.search = e.target.value; render(); });

      // Add item
      document.getElementById('addBtn').addEventListener('click', () => {
        const item = {
          title: val('f_title').trim(),
          quarter: val('f_quarter'),
          owner: val('f_owner').trim(),
          team: val('f_team').trim(),
          reach: num('f_reach'),
          impact: parseFloat(val('f_impact')),
          confidence: parseFloat(val('f_confidence')),
          effort: parseFloat(val('f_effort')),
          dependsOn: val('f_depends').split(',').map(s=>s.trim()).filter(Boolean),
          description: val('f_description')
        };
        if(!item.title){ alert('Please enter a title'); return; }

        const extra = JSON.parse(localStorage.getItem(LS_KEY) || "[]");
        extra.push(item);
        localStorage.setItem(LS_KEY, JSON.stringify(extra));
        state.items.push(item);

        document.getElementById('f_title').value = "";
        document.getElementById('f_description').value = "";
        document.getElementById('f_depends').value = "";
        refreshDepSuggestions();
        render();
        window.scrollTo({top:0, behavior:'smooth'});
      });

      // Download / Reset
      document.getElementById('downloadBtn').addEventListener('click', () => {
        const blob = new Blob([JSON.stringify(state.items, null, 2)], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'data.json';
        a.click();
        URL.revokeObjectURL(a.href);
      });
      document.getElementById('resetLocalBtn').addEventListener('click', () => {
        if(confirm('Clear your locally added projects?')) {
          localStorage.removeItem(LS_KEY);
          load();
        }
      });

      // Capacity planner
      document.getElementById('planBtn').addEventListener('click', () => {
        const q = val('planQuarter');
        const cap = Math.max(0, parseFloat(val('planCapacity') || '0'));
        const items = state.items.filter(i => i.quarter === q);
        if(items.length === 0){
          document.getElementById('planOut').innerHTML = '<div class="help">No items for that quarter.</div>'; return;
        }
        const idx = new Map(items.map((it, k) => [it.title.trim().toLowerCase(), k]));
        const n = items.length, W = Math.floor(cap);
        const dp = Array.from({length:n+1}, ()=>Array(W+1).fill(0));
        for(let i=1;i<=n;i++){
          const it = items[i-1];
          const w = Math.min(W, Math.max(0, Math.floor(it.effort||0)));
          const v = riceScore(it);
          for(let wgt=0; wgt<=W; wgt++){
            dp[i][wgt] = dp[i-1][wgt];
            if(w>0 && w<=wgt) dp[i][wgt] = Math.max(dp[i][wgt], dp[i-1][wgt-w] + v);
          }
        }
        let wgt=W; const chosen=[];
        for(let i=n;i>=1;i--){
          if(dp[i][wgt]!==dp[i-1][wgt]){
            const it = items[i-1];
            chosen.push(it);
            wgt -= Math.min(W, Math.max(0, Math.floor(it.effort||0)));
          }
        }
        chosen.reverse();

        const chosenSet = new Set(chosen.map(i=>i.title.trim().toLowerCase()));
        let addedDeps = [];
        for(const it of [...chosen]){
          for(const d of (it.dependsOn||[])){
            const key = d.trim().toLowerCase();
            if(!key) continue;
            if(!chosenSet.has(key) && idx.has(key)){
              const dep = items[idx.get(key)];
              const e = Math.max(0, Math.floor(dep.effort||0));
              if(wgt - e >= 0){
                chosen.push(dep); chosenSet.add(key); wgt -= e; addedDeps.push(dep.title);
              }
            }
          }
        }

        const totalEffort = chosen.reduce((s,i)=>s+Number(i.effort||0),0);
        const totalRICE = chosen.reduce((s,i)=>s+riceScore(i),0);
        const overflow = items.filter(i => !chosenSet.has(i.title.trim().toLowerCase()));

        document.getElementById('planOut').innerHTML = `
          <div><strong>Quarter:</strong> ${escapeHtml(q)} &nbsp; <strong>Capacity:</strong> ${cap}</div>
          <div class="help">Selected ${chosen.length} items (effort ${totalEffort.toFixed(1)}, RICE total ${totalRICE}).</div>
          ${addedDeps.length ? `<div class="help">Included dependencies: ${addedDeps.map(escapeHtml).join(', ')}</div>` : ''}
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:8px;">
            <div><strong>✅ Fits</strong><ul>${chosen.map(i=>`<li>${escapeHtml(i.title)} <span style="color:var(--muted)">(E${i.effort}, R${riceScore(i)})</span></li>`).join('')}</ul></div>
            <div><strong>⏭ Overflow</strong><ul>${overflow.map(i=>`<li>${escapeHtml(i.title)} <span style="color:var(--muted)">(E${i.effort}, R${riceScore(i)})</span></li>`).join('')}</ul></div>
          </div>`;
      });

      // Local quick scoring
      document.getElementById('aiLocalBtn').addEventListener('click', () => {
        const title = val('f_title').toLowerCase();
        const desc  = val('f_description').toLowerCase();
        const text = title + " " + desc;

        const bigReach   = /onboard|signup|email|notification|search|feed|mobile|landing|ai assistant|automa|automation|import|export/.test(text);
        const infra      = /sdk|api|adapter|platform|infra|schema|pipeline|etl|migration|refactor|cache|index/.test(text);
        const analytics  = /analytics|dashboard|insight|metric|report|cohort|funnel|experiment|ab test/.test(text);
        const risk       = /privacy|security|trust|auth|gdpr|consent|pci|audit|bias|safety/.test(text);
        const newFlow    = /onboard|checkout|wizard|flow|journey|activation|retention/.test(text);

        let reach = 200; if(bigReach) reach = 800; if(analytics) reach = Math.max(reach, 600); if(infra) reach = Math.min(reach, 400);
        let impact = 2; if(newFlow || bigReach) impact = 3; if(infra) impact = Math.min(impact, 2); if(/bug|fix|minor|copy/.test(text)) impact = 1;
        let effort = 2; if(infra || risk) effort = 3; if(/rewrite|migration|platform|data warehouse|real\-time/.test(text)) effort = 4; if(/mvp|prototype|quick|small/.test(text)) effort = 1;
        let confidence = 0.8; if(/hypothesis|explore|spike|idea/.test(text)) confidence = 0.6; if(/validated|user research|beta|pilot|data shows/.test(text)) confidence = 1.0;

        document.getElementById('f_reach').value = reach;
        document.getElementById('f_impact').value = String(impact);
        document.getElementById('f_effort').value = String(effort);
        document.getElementById('f_confidence').value = String(confidence);

        const aiExplain = document.getElementById('aiExplain');
        aiExplain.style.display = 'block';
        aiExplain.innerHTML = `<strong>Estimate help:</strong> Reach ~${reach}, Impact ${impact}, Effort ${effort}, Confidence ${confidence}. Adjust as needed.`;
      });

      // Ask AI (optional)
      const askBtn = document.getElementById('askAIBtn');
      const aiNote = document.getElementById('aiNote');
      if(!AI_KEY || !AI_ENDPOINT){ askBtn.style.display = 'none'; } else { aiNote.style.display = 'none'; }
      askBtn?.addEventListener('click', async () => {
        const title = val('f_title').trim();
        const description = val('f_description').trim();
        if(!title || !description){ alert('Add a title and a one-liner first.'); return; }
        askBtn.disabled = true; askBtn.textContent = 'Thinking…';
        try{
          const resp = await fetch(AI_ENDPOINT, {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${AI_KEY}` },
            body: JSON.stringify({ title, description, task: "estimate_rice_and_rationale" })
          });
          if(!resp.ok) throw new Error('AI request failed');
          const data = await resp.json();
          if(data.reach) document.getElementById('f_reach').value = data.reach;
          if(data.impact) document.getElementById('f_impact').value = String(data.impact);
          if(data.effort) document.getElementById('f_effort').value = String(data.effort);
          if(data.confidence) document.getElementById('f_confidence').value = String(data.confidence);
          const aiExplain = document.getElementById('aiExplain');
          aiExplain.style.display = 'block';
          aiExplain.innerHTML = `<strong>Estimate help:</strong> ${escapeHtml(data.rationale || 'Suggested values based on similar projects.')}`;
        }catch(err){
          alert('Could not reach your AI endpoint. Check AI_ENDPOINT / AI_API_KEY.');
        }finally{
          askBtn.disabled = false; askBtn.textContent = 'Ask AI';
        }
      });

      // Themes (clustering)
      function inferTheme(it){
        const t = (it.title + ' ' + (it.description||'')).toLowerCase();
        if(/onboard|signup|activation|first run|welcome|wizard/.test(t)) return 'Onboarding';
        if(/growth|referral|vir(al|ality)|invite|share|conversion/.test(t)) return 'Growth';
        if(/trust|privacy|security|consent|gdpr|auth|fraud|bias/.test(t)) return 'Trust';
        if(/analytics|insight|dashboard|report|cohort|funnel/.test(t)) return 'Analytics';
        if(/infra|platform|sdk|api|adapter|pipeline|etl|migration|refactor|cache|index/.test(t)) return 'Platform/Infra';
        if(/billing|payment|checkout|invoice|subscription|stripe/.test(t)) return 'Monetisation';
        return 'Other';
      }
      function showThemes(){
        if(!state.items.length){ alert('No items loaded yet.'); return; }
        const groups = new Map();
        for(const it of state.items){
          const g = inferTheme(it);
          if(!groups.has(g)) groups.set(g, []);
          groups.get(g).push(it);
        }
        const out = [...groups.entries()].map(([name, arr])=>{
          const list = arr.map(i=>`<li>${escapeHtml(i.title)} <span class="meta">(RICE ${riceScore(i)})</span></li>`).join('');
          return `<div class="card"><strong>${escapeHtml(name)}</strong><div class="meta">${arr.length} item${arr.length>1?'s':''}</div><ul style="margin-left:18px;">${list}</ul></div>`;
        }).join('');
        const section = document.getElementById('themesSection');
        document.getElementById('themesOut').innerHTML = out || '<div class="help">No items to cluster.</div>';
        section.style.display = 'block';
        section.scrollIntoView({behavior:'smooth', block:'start'});
      }
      document.getElementById('themesBtn').addEventListener('click', showThemes);

      // Weekly narrative (3 bullets)
      function loadSnapshot(){ try{ return JSON.parse(localStorage.getItem(SNAP_KEY) || 'null'); }catch{ return null; } }
      function saveSnapshot(){ const snap = { ts: Date.now(), items: state.items.map(i => ({...i})) }; localStorage.setItem(SNAP_KEY, JSON.stringify(snap)); }
      function summariseChanges(){
        const snap = loadSnapshot();
        if(!snap){ saveSnapshot(); return ["Saved a baseline. Come back later and click again for changes."]; }
        const nowItems = state.items.map(i=>({title:i.title, quarter:i.quarter, hash: JSON.stringify({r:i.reach, i:i.impact, c:i.confidence, e:i.effort, d:i.description, deps:(i.dependsOn||[]).slice().sort()})}));
        const then = new Map(snap.items.map(i => [i.title, i]));
        const now  = new Map(nowItems.map(i => [i.title, i]));
        const added   = [...now.keys()].filter(k => !then.has(k));
        const removed = [...then.keys()].filter(k => !now.has(k));
        const changed = [...now.keys()].filter(k => {
          if(!then.has(k)) return false;
          const prev = then.get(k);
          const prevHash = JSON.stringify({r:prev.reach,i:prev.impact,c:prev.confidence,e:prev.effort,d:prev.description,deps:(prev.dependsOn||[]).slice().sort()});
          return JSON.stringify(now.get(k).hash) !== JSON.stringify(prevHash);
        });
        const bullets = [];
        if(added.length)   bullets.push(`Added ${added.length}: ${added.slice(0,3).join(', ')}${added.length>3?'…':''}.`);
        if(changed.length) bullets.push(`Updated ${changed.length}: ${changed.slice(0,3).join(', ')}${changed.length>3?'…':''}.`);
        if(removed.length) bullets.push(`Removed ${removed.length}: ${removed.slice(0,3).join(', ')}${removed.length>3?'…':''}.`);
        if(!bullets.length) bullets.push('No material changes since last snapshot.');
        saveSnapshot();
        return bullets.slice(0,3);
      }
      function showWeekly(){
        const section = document.getElementById('weeklySection');
        const bullets = summariseChanges();
        document.getElementById('weeklyOut').innerHTML = `<ul style="margin-left:18px">${bullets.map(b=>`<li>${escapeHtml(b)}</li>`).join('')}</ul>`;
        section.style.display = 'block';
        section.scrollIntoView({behavior:'smooth', block:'start'});
      }
      document.getElementById('weeklyBtn').addEventListener('click', showWeekly);

      // Theme toggle
      const rootEl = document.documentElement;
      const btnToggle = document.getElementById("themeToggle");
      const icon = document.getElementById("themeIcon");
      const label = document.getElementById("themeLabel");

      function applySavedTheme(){
        const saved = localStorage.getItem(THEME_KEY);
        if(saved === "light" || saved === "dark"){ rootEl.setAttribute("data-theme", saved); }
        else { rootEl.removeAttribute("data-theme"); }
        updateToggleVisuals();
      }
      function toggleTheme(){
        const forced = rootEl.getAttribute("data-theme");
        const next = forced === "dark" ? "light" : "dark";
        rootEl.setAttribute("data-theme", next);
        localStorage.setItem(THEME_KEY, next);
        updateToggleVisuals();
      }
      function updateToggleVisuals(){
        const isDarkForced = rootEl.getAttribute("data-theme") === "dark";
        const isDarkAuto = !rootEl.getAttribute("data-theme") && window.matchMedia("(prefers-color-scheme: dark)").matches;
        const isDark = isDarkForced || isDarkAuto;
        icon.textContent = isDark ? "☀️" : "🌙";
        label.textContent = isDark ? "Light" : "Dark";
      }
      btnToggle.addEventListener("click", toggleTheme);

      // go!
      applySavedTheme();
      load();
    </script>
  </body>
</html>
